<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Map</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA4cVXQgyJq-DSWAA_CfAagMIA6xnW8PhU"></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
        .time-filters {
            margin-bottom: 20px;
        }
        .time-filters button {
            margin-right: 10px;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>足跡</h1>
    <div class="time-filters">
        <button onclick="filterLocations('1')">今日</button>
        <button onclick="filterLocations('7')">當周</button>
        <button onclick="filterLocations('30')">當月</button>
        <button onclick="filterLocations('all')">全部</button>
    </div>

    <div id="map"></div>    
<script>
    var MainUserID = "{{ MainUserID }}"; // 從後端獲取的 MainUserID

    function initMap(locations) {
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 10,
            center: {lat: 0, lng: 0}
        });

        var bounds = new google.maps.LatLngBounds();
        var pathCoordinates = [];

        locations.forEach(function(location) {
            var coords = location.match(/query=([-.\d]+),([-.\d]+)/);
            if (coords) {
                var latLng = new google.maps.LatLng(parseFloat(coords[1]), parseFloat(coords[2]));
                
                // 添加標記
                var marker = new google.maps.Marker({
                    position: latLng,
                    map: map
                });

                // 擴展邊界以適應所有標記
                bounds.extend(latLng);

                // 將位置添加到路徑坐標中
                pathCoordinates.push(latLng);
            }
        });

        if (pathCoordinates.length > 0) {
            // 創建並添加折線到地圖
            var flightPath = new google.maps.Polyline({
                path: pathCoordinates,
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2
            });

            flightPath.setMap(map);
        }

        if (!bounds.isEmpty()) {
            map.fitBounds(bounds);
        }
    }

    function filterLocations(timePeriod) {
        // 發送 GET 請求到後端的 /road 路由，附帶 MainUserID 和時間範圍
        fetch(`/gps/road?MainUserID=${MainUserID}&time=${timePeriod}`)
            .then(response => response.json())
            .then(data => {
                // 使用返回的數據初始化地圖
                initMap(data.urls);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // 預設顯示全部足跡
    filterLocations('all');
</script>
</body>
</html>
